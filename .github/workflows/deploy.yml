name: Android & iOS CI/CD

on:
  push:
    branches:
      - main

jobs:
  android-deploy:
    name: ðŸ“± Android Build & Deploy
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¦ Checkout Code
        uses: actions/checkout@v3

      - name: ðŸ”§ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '23'

      - name: ðŸ“¥ Install Dependencies
        run: npm install

      - name: â˜• Set up Java JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ðŸ” Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 --decode > android/app/my-release-key.keystore

      - name: ðŸ—ï¸ Build Android AAB
        run: |
          cd android
          ./gradlew bundleRelease --stacktrace

      - name: ðŸ”‘ Authenticate with Google Play
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.PLAY_STORE_JSON_KEY }}

      - name: ðŸš€ Upload to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_JSON_KEY }}
          packageName: com.mycoachapp
          releaseFiles: android/app/build/outputs/bundle/release/app-release.aab
          track: production

  ios-deploy:
    name: ðŸ iOS Build & Deploy
    runs-on: macos-latest

    steps:
      - name: ðŸ“¦ Checkout Code
        uses: actions/checkout@v3

      - name: ðŸ”§ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '23'

      - name: ðŸ“¥ Install Dependencies
        run: npm install

      - name: ðŸŽ Install CocoaPods
        run: |
          cd ios
          pod install

      - name: ðŸ’Ž Install Bundler & Fastlane
        run: |
          sudo gem install bundler
          bundle install
          bundle exec fastlane --version

      - name: ðŸ” Set Up App Store Connect API Key
        run: |
          echo "${{ secrets.APP_STORE_CONNECT_KEY }}" | base64 --decode > AuthKey.p8

      - name: ðŸš€ Deploy to TestFlight / App Store
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_KEY_PATH: AuthKey.p8
        run: |
          cd ios
          bundle exec fastlane ios beta
